<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç»¼åˆå­¦ä¹ ä¹å›­ (V8_final)</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <style>
        :root {
            --bg-color: #f8f6f2; --card-bg-color: #ffffff; --char-color: #34495e;
            --grid-color: #e5e7eb; --red-color: #c0392b; --blue-color: #3498db;
            --yellow-color: #f39c12; --gray-color: #7f8c8d; --green-color: #27ae60;
            --selection-bg-color: #d4eaf7; --selection-border-color: var(--blue-color);
            --font-main: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            --font-char: 'KaiTi', 'æ¥·ä½“', serif;
            --font-latin: Arial, sans-serif;
        }
        *, *::before, *::after { box-sizing: border-box; }
        body { font-family: var(--font-main); display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; padding: 20px 0; background-color: var(--bg-color); background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23dcdcdc' fill-opacity='0.1'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E"); }
        .screen { position: absolute; opacity: 1; visibility: visible; transform: translateY(0); transition: opacity 0.35s ease, transform 0.35s ease, visibility 0.35s; }
        .screen.hidden { opacity: 0; transform: translateY(-10px); visibility: hidden; }
        .card { background-color: var(--card-bg-color); padding: 30px; border-radius: 20px; box-shadow: 0 15px 50px rgba(0, 0, 0, 0.1); width: 90vw; max-width: 500px; text-align: center; }
        h1 { margin: 0 0 25px 0; font-size: 2.2em; color: var(--char-color); }
        .btn { width: 100%; padding: 14px; margin-top: 10px; font-size: 1.1em; font-weight: bold; color: white; border: none; border-radius: 12px; cursor: pointer; transition: transform 0.1s ease, filter 0.2s; }
        .btn:hover { filter: brightness(1.05); }
        .btn:active { transform: scale(0.97); }
        .btn-lg { padding: 16px; font-size: 1.2em; }
        .btn-primary { background-color: var(--blue-color); } .btn-warning { background-color: var(--yellow-color); } .btn-danger { background-color: var(--red-color); } .btn-secondary { background-color: var(--gray-color); } .btn-success { background-color: var(--green-color); }
        .btn-group { display: flex; gap: 15px; }
        input, textarea, select { width: 100%; padding: 12px; font-size: 1em; border-radius: 8px; border: 1px solid #ccc; margin-bottom: 12px; }
        details { border: 1px solid #eee; border-radius: 12px; margin-top: 15px; }
        summary { font-weight: bold; cursor: pointer; padding: 15px; list-style: none; display: block; }
        summary::-webkit-details-marker { display: none; }
        summary::before { content: 'â–¶ '; font-size: 0.8em; }
        details[open] summary::before { content: 'â–¼ '; }
        .details-content { padding: 0 15px 15px 15px; }
        #home-screen .btn { margin-bottom: 10px; }
        
        #char-display-container { position: relative; width: 100%; margin-bottom: 25px; display: flex; justify-content: center; align-items: center; min-height: 320px; padding: 5px; }
        #char-display { display: flex; justify-content: center; align-items: center; width: auto; max-width: 100%; gap: 15px; color: var(--char-color); animation: fadeIn 0.4s ease; transition: transform 0.2s ease-out; }
        
        .char-cell-container { position: relative; display: flex; justify-content: center; align-items: center; flex-shrink: 0; width: 150px; height: 150px; }
        .char-cell-container.is-single { width: 320px; height: 320px; }
        
        .char-cell-grid { position: absolute; width: 100%; height: 100%; border: 3px solid var(--grid-color); }
        .char-cell-grid::before, .char-cell-grid::after { content: ''; position: absolute; background-color: var(--grid-color); }
        .char-cell-grid::before { width: 2px; height: 100%; top: 0; left: 50%; transform: translateX(-50%); }
        .char-cell-grid::after { height: 2px; width: 100%; top: 50%; left: 0; transform: translateY(-50%); }
        .is-single .char-cell-grid { border-width: 4px; }

        .char-cell-text { position: relative; font-family: var(--font-char); font-size: 120px; }
        .is-single .char-cell-text { font-size: 260px; }

        .char-item-latin { display: flex; justify-content: center; align-items: center; flex-wrap: wrap; font-family: var(--font-latin); font-weight: bold; text-align: center; max-width: 100%; font-size: clamp(3rem, 10vw, 6rem); line-height: 1.2; }
        .char-item-latin.is-pinyin { white-space: nowrap; }

        #stats { position: absolute; top: -10px; right: 0; font-size: 1.1em; color: #888; background-color: rgba(248, 246, 242, 0.8); padding: 5px 12px; border-radius: 10px; z-index: 3; }
        #bank-selection-list { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 25px; }
        @media (max-width: 520px) { #bank-selection-list { grid-template-columns: repeat(2, 1fr); } :root { --font-char: var(--font-main); } .char-cell-container.is-single { width: 280px; height: 280px; } .is-single .char-cell-text { font-size: 220px; } .char-item-latin { font-size: clamp(2.5rem, 12vw, 5rem); } }
        .bank-item { padding: 25px 10px; border: 2px solid #eee; border-radius: 12px; font-weight: bold; font-size: 1.1em; cursor: pointer; transition: all 0.2s ease-in-out; text-align: center; }
        .bank-item.selected { background-color: var(--selection-bg-color); border-color: var(--selection-border-color); color: var(--blue-color); transform: scale(1.05); }
        #history-list { font-size: 0.9em; text-align: left; padding-left: 10px; }
        .history-item .wrong-chars { color: var(--red-color); font-weight: bold; }
        
        /* --- æœ€ç»ˆä¿®å¤ï¼šä»åŠ¨ç”»ä¸­ç§»é™¤transformï¼Œä»¥é˜²æ­¢ç¼©æ”¾å†²çª --- */
        @keyframes fadeIn { 
            from { opacity: 0; } 
            to { opacity: 1; } 
        }
    </style>
</head>
<body>
    <div id="home-screen" class="screen card"><h1>ç»¼åˆå­¦ä¹ ä¹å›­</h1><button id="select-hanzi" class="btn btn-lg btn-primary">å­¦ä¹ æ±‰å­—</button><button id="select-pinyin" class="btn btn-lg btn-success">å­¦ä¹ æ‹¼éŸ³</button><button id="select-english" class="btn btn-lg btn-danger">å­¦ä¹ è‹±è¯­</button><details><summary>æ•°æ®ç®¡ç†</summary><div class="details-content"><p style="text-align:left; font-size: 0.9em; color: #555;">æ‚¨å¯ä»¥å°†æ‰€æœ‰æ•°æ®ï¼ˆå­—åº“ã€é”™é¢˜æœ¬ï¼‰å¯¼å‡ºä¸ºæ–‡ä»¶å¤‡ä»½ï¼Œæˆ–ä»æ–‡ä»¶å¯¼å…¥ï¼Œæ–¹ä¾¿åœ¨ä¸åŒç”µè„‘é—´ä½¿ç”¨ã€‚</p><div class="btn-group"><button id="export-data-btn" class="btn btn-secondary">å¯¼å‡ºå…¨éƒ¨æ•°æ®</button><button id="import-data-btn" class="btn btn-secondary">å¯¼å…¥æ•°æ®</button></div><input type="file" id="import-file-input" style="display: none;" accept=".json"></div></details></div>
    <div id="setup-screen" class="screen card hidden"><h1 id="setup-title"></h1><div id="bank-selection-list"></div><div class="btn-group"><button id="start-btn" class="btn btn-primary btn-lg">å¼€å§‹å­¦ä¹ </button><button id="practice-wrong-btn" class="btn btn-warning btn-lg">ç»ƒä¹ é”™é¢˜æœ¬</button></div><details><summary>å†…å®¹ç®¡ç†</summary><div class="details-content"><h4>å­—åº“/è¯åº“ç¼–è¾‘</h4><select id="bank-edit-select"></select><input type="text" id="edit-bank-name" placeholder="è¯åº“åç§°"><textarea id="edit-bank-chars" rows="4" placeholder="æ¯ä¸ªè¯æ¡å ä¸€è¡Œ, ç”¨å›è½¦åˆ†éš”"></textarea><div class="btn-group"><button id="save-bank-btn" class="btn btn-secondary">ä¿å­˜/æ›´æ–°</button><button id="delete-bank-btn" class="btn btn-danger">åˆ é™¤é€‰ä¸­</button></div><h4 style="margin-top:20px; margin-bottom:10px;">é”™é¢˜æœ¬ç¼–è¾‘</h4><textarea id="edit-wrong-chars" rows="3" placeholder="æ‰‹åŠ¨ç¼–è¾‘é”™é¢˜æœ¬, æ¯è¡Œä¸€ä¸ª"></textarea><button id="save-wrong-chars-btn" class="btn btn-secondary">ä¿å­˜é”™é¢˜æœ¬</button></div></details><details><summary>ç»ƒä¹ å†å²</summary><div id="history-list" class="details-content"></div></details><button id="back-to-home-btn" class="btn btn-secondary" style="margin-top: 20px;">è¿”å›ä¸»é¡µ</button></div>
    <div id="main-screen" class="screen card hidden"><div id="char-display-container"><div id="stats"><span id="timer">00:00</span> | å‰©ä½™: <span id="remaining-count">0</span></div><div id="char-display"></div></div><div class="btn-group"><button id="correct-btn" class="btn btn-success btn-lg">ğŸ˜Š è®¤è¯†</button><button id="incorrect-btn" class="btn btn-danger btn-lg">ğŸ˜¥ ä¸è®¤è¯†</button></div></div>
    <div id="result-screen" class="screen card hidden"><h1 id="result-title"></h1><p>æ€»ç”¨æ—¶ï¼š<strong id="final-time"></strong></p><p>æœ¬æ¬¡é”™é¢˜ï¼š<strong id="incorrect-list" style="color: var(--red-color);"></strong></p><button id="home-btn" class="btn btn-secondary">è¿”å›ä¸»é¡µ</button></div>

    <script>
        const $ = (selector) => document.querySelector(selector);
        const screens = { home: $("#home-screen"), setup: $("#setup-screen"), main: $("#main-screen"), result: $("#result-screen") };
        const elements = {
            selectHanziBtn: $("#select-hanzi"), selectPinyinBtn: $("#select-pinyin"), selectEnglishBtn: $("#select-english"), exportDataBtn: $("#export-data-btn"), importDataBtn: $("#import-data-btn"), importFileInput: $("#import-file-input"), setupTitle: $("#setup-title"), backToHomeBtn: $("#back-to-home-btn"), bankSelectionList: $("#bank-selection-list"), bankEditSelect: $("#bank-edit-select"), startBtn: $("#start-btn"), practiceWrongBtn: $("#practice-wrong-btn"), editBankName: $("#edit-bank-name"), editBankChars: $("#edit-bank-chars"), saveBankBtn: $("#save-bank-btn"), deleteBankBtn: $("#delete-bank-btn"), editWrongChars: $("#edit-wrong-chars"), saveWrongCharsBtn: $("#save-wrong-chars-btn"), historyList: $("#history-list"), timer: $("#timer"), remainingCount: $("#remaining-count"), charDisplay: $("#char-display"), charDisplayContainer: $("#char-display-container"), correctBtn: $("#correct-btn"), incorrectBtn: $("#incorrect-btn"), resultTitle: $("#result-title"), finalTime: $("#final-time"), incorrectList: $("#incorrect-list"), homeBtn: $("#home-btn"),
        };
        let state = { currentSubject: null, charsToPractice: [], currentChar: '', incorrectThisSession: [], seconds: 0, timerInterval: null, currentSessionSource: '' };
        const DB = { get: (key, def) => JSON.parse(localStorage.getItem(key)) || def, set: (key, val) => localStorage.setItem(key, JSON.stringify(val)), getForSubject: (subject, key, def) => DB.get(`${subject}_${key}`, def), setForSubject: (subject, key, val) => DB.set(`${subject}_${key}`, val) };
        const UI = {
            switchScreen(s) { Object.values(screens).forEach(c=>c.classList.add('hidden')); screens[s].classList.remove('hidden'); },
            updateSetupScreen(subject) { const titles = { hanzi: 'æ±‰å­—å­¦ä¹ ', pinyin: 'æ‹¼éŸ³å­¦ä¹ ', english: 'è‹±è¯­å­¦ä¹ ' }; elements.setupTitle.textContent = titles[subject]; this.renderBankSelectionList(subject); this.renderBankEditSelect(subject); this.renderWrongWordEditor(subject); this.renderHistory(subject); const wrongCount = DB.getForSubject(subject, 'wrongChars', []).length; elements.practiceWrongBtn.textContent = `ç»ƒä¹ é”™é¢˜æœ¬ ${wrongCount > 0 ? `(${wrongCount})` : ''}`; },
            renderBankSelectionList(subject) { const banks = DB.getForSubject(subject, 'wordBanks', {}); const bankNames = Object.keys(banks); elements.bankSelectionList.innerHTML = bankNames.length ? '' : '<p style="text-align:center; color:#888; grid-column: 1 / -1;">è¯·åœ¨ä¸‹æ–¹ç®¡ç†é¢æ¿åˆ›å»ºå†…å®¹åº“</p>'; bankNames.forEach(name => { const item = document.createElement('div'); item.className = 'bank-item'; item.textContent = name; item.dataset.bankName = name; item.onclick = () => item.classList.toggle('selected'); elements.bankSelectionList.appendChild(item); }); },
            renderBankEditSelect(subject) { const banks = DB.getForSubject(subject, 'wordBanks', {}); const bankNames = Object.keys(banks); elements.bankEditSelect.innerHTML = bankNames.length ? '' : '<option value="">æ— å†…å®¹åº“å¯ç¼–è¾‘</option>'; bankNames.forEach(name => elements.bankEditSelect.add(new Option(name, name))); this.populateBankEditor(subject, elements.bankEditSelect.value); },
            populateBankEditor(subject, bankName) { const banks = DB.getForSubject(subject, 'wordBanks', {}); elements.editBankName.value = banks[bankName] ? bankName : ''; elements.editBankChars.value = banks[bankName] ? banks[bankName].join('\n') : ''; },
            renderWrongWordEditor(subject) { elements.editWrongChars.value = DB.getForSubject(subject, 'wrongChars', []).join('\n'); },
            renderHistory(subject) { const history = DB.getForSubject(subject, 'practiceHistory', []); elements.historyList.innerHTML = history.length ? '' : '<p>æš‚æ— å†å²è®°å½•</p>'; history.slice(0, 5).forEach(item => { elements.historyList.innerHTML += `<div class="history-item"><p><strong>${item.date} [${item.source}]</strong> - ${item.time}<br>é”™: <span class="wrong-chars">${item.wrong.join(', ') || 'æ— '}</span></p></div>`; }); },
            updateStats() { elements.remainingCount.textContent = state.charsToPractice.length; elements.timer.textContent = this.formatTime(state.seconds); },
            formatTime: (s) => `${String(Math.floor(s/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`
        };
        
        function resetAppToHome() {
            clearInterval(state.timerInterval);
            state = { currentSubject: null, charsToPractice: [], currentChar: '', incorrectThisSession: [], seconds: 0, timerInterval: null, currentSessionSource: '' };
            elements.charDisplay.innerHTML = '';
            elements.charDisplay.style.transform = 'scale(1)';
            UI.switchScreen('home');
        }

        function startSession(chars, sourceName) { if (!chars || chars.length === 0) { alert('æ²¡æœ‰éœ€è¦å­¦ä¹ çš„å†…å®¹ï¼'); return; } state.charsToPractice = shuffleArray([...new Set(chars)]); state.incorrectThisSession = []; state.currentSessionSource = sourceName; UI.switchScreen('main'); startTimer(); nextChar(); }
        
        function nextChar() {
            UI.updateStats();
            if (state.charsToPractice.length === 0) { endSession(); return; }
            state.currentChar = state.charsToPractice[0];
            const display = elements.charDisplay;
            const displayContainer = elements.charDisplayContainer;
            
            display.style.visibility = 'hidden';
            display.style.animation = 'none';
            display.innerHTML = '';
            display.style.transform = ''; // é‡ç½®transformä»¥æ­£ç¡®æµ‹é‡

            if (state.currentSubject === 'hanzi') {
                const isSingle = state.currentChar.length === 1;
                for (const char of state.currentChar) {
                    const container = document.createElement('div');
                    container.className = 'char-cell-container';
                    if (isSingle) container.classList.add('is-single');
                    container.innerHTML = `<div class="char-cell-grid"></div><div class="char-cell-text">${char}</div>`;
                    display.appendChild(container);
                }
            } else {
                const item = document.createElement('div');
                item.className = 'char-item-latin';
                if (state.currentSubject === 'pinyin') { item.classList.add('is-pinyin'); }
                item.textContent = state.currentChar;
                display.appendChild(item);
            }
            
            requestAnimationFrame(() => {
                const containerWidth = displayContainer.clientWidth;
                const contentWidth = display.scrollWidth;
                if (contentWidth > containerWidth) {
                    const scale = (containerWidth - 20) / contentWidth;
                    display.style.transform = `scale(${scale})`;
                }
                display.style.visibility = 'visible';
                display.style.animation = 'fadeIn 0.4s ease';
            });
        }

        function handleAnswer(isCorrect) { if (isCorrect) { state.charsToPractice.shift(); } else { const wrongChars = new Set(DB.getForSubject(state.currentSubject, 'wrongChars', [])); wrongChars.add(state.currentChar); DB.setForSubject(state.currentSubject, 'wrongChars', [...wrongChars]); if (!state.incorrectThisSession.includes(state.currentChar)) { state.incorrectThisSession.push(state.currentChar); } if (state.charsToPractice.length > 1) { const incorrectItem = state.charsToPractice.shift(); const halfway = Math.ceil(state.charsToPractice.length / 2); const insertIndex = halfway + Math.floor(Math.random() * (state.charsToPractice.length - halfway + 1)); state.charsToPractice.splice(insertIndex, 0, incorrectItem); } } nextChar(); }
        function endSession() { clearInterval(state.timerInterval); state.timerInterval = null; const history = DB.getForSubject(state.currentSubject, 'practiceHistory', []); history.unshift({ date: new Date().toLocaleDateString(), source: state.currentSessionSource, time: UI.formatTime(state.seconds), wrong: state.incorrectThisSession }); DB.setForSubject(state.currentSubject, 'practiceHistory', history.slice(0, 10)); elements.finalTime.textContent = UI.formatTime(state.seconds); if (state.incorrectThisSession.length === 0) { elements.resultTitle.textContent = "å¤ªæ£’äº†ï¼Œå…¨å¯¹ï¼ğŸ‰"; elements.incorrectList.textContent = 'æ— '; confetti({ particleCount: 150, spread: 90, origin: { y: 0.6 } }); } else { elements.resultTitle.textContent = "å¾ˆæ£’ï¼Œç»§ç»­åŠ æ²¹ï¼ğŸ’ª"; elements.incorrectList.textContent = state.incorrectThisSession.join('ï¼Œ'); confetti({ particleCount: 50, spread: 60, origin: { y: 0.6 } }); } UI.switchScreen('result'); }
        function initializeSubject(subject) { state.currentSubject = subject; UI.updateSetupScreen(subject); UI.switchScreen('setup'); }
        function initDefaultData() { if (!localStorage.getItem('pinyin_wordBanks')) { const pinyinDefaults = { 'å£°æ¯': 'b p m f d t n l g k h j q x zh ch sh r z c s y w'.split(' '),'éŸµæ¯': 'a o e i u Ã¼ ai ei ui ao ou iu ie Ã¼e er an en in un Ã¼n ang eng ing ong'.split(' '),'æ•´ä½“è®¤è¯»': 'zhi chi shi ri zi ci si yi wu yu ye yue yuan yin yun ying'.split(' ')}; DB.setForSubject('pinyin', 'wordBanks', pinyinDefaults); } if (!localStorage.getItem('english_wordBanks')) { const englishDefaults = { 'å¤§å†™å­—æ¯': 'A B C D E F G H I J K L M N O P Q R S T U V W X Y Z'.split(' '),'å°å†™å­—æ¯': 'a b c d e f g h i j k l m n o p q r s t u v w x y z'.split(' ')}; DB.setForSubject('english', 'wordBanks', englishDefaults); } if (!localStorage.getItem('hanzi_wordBanks')) { const hanziDefaults = { 'åŸºç¡€å¸¸ç”¨å­—': 'çš„\nä¸€\næ˜¯\näº†\næˆ‘\nä¸\näºº\nå’Œ\nåœ¨\nä»–\næœ‰\nè¿™\nä¸ª\nä¸Š\nä»¬\næ¥\nåˆ°\nå¤§\nä¸º\nå­\nä¸­\nä½ \nè¯´\nç”Ÿ\nå›½\nè¿‡\nä¼š'.split(/\n+/)}; DB.setForSubject('hanzi', 'wordBanks', hanziDefaults); } }
        function exportData() { const dataToExport = {}; const keys = ['hanzi_wordBanks', 'hanzi_wrongChars', 'hanzi_practiceHistory', 'pinyin_wordBanks', 'pinyin_wrongChars', 'pinyin_practiceHistory', 'english_wordBanks', 'english_wrongChars', 'english_practiceHistory']; keys.forEach(key => { dataToExport[key] = JSON.parse(localStorage.getItem(key)) || null; }); const dataStr = JSON.stringify(dataToExport, null, 2); const blob = new Blob([dataStr], {type: "application/json"}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `ç»¼åˆå­¦ä¹ ä¹å›­_å¤‡ä»½_${new Date().toISOString().slice(0,10)}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); alert('æ•°æ®å·²å¯¼å‡ºï¼è¯·å¦¥å–„ä¿ç®¡å¤‡ä»½æ–‡ä»¶ã€‚'); }
        function importData(event) { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = function(e) { try { const data = JSON.parse(e.target.result); const keys = Object.keys(data); if (!keys.some(k => k.includes('_wordBanks') || k.includes('_wrongChars'))) { throw new Error("æ— æ•ˆçš„æ•°æ®æ–‡ä»¶"); } if (confirm('å¯¼å…¥æ•°æ®ä¼šè¦†ç›–ç°æœ‰æ‰€æœ‰å†…å®¹ï¼Œç¡®å®šè¦ç»§ç»­å—ï¼Ÿ')) { localStorage.clear(); keys.forEach(key => { if(data[key]) localStorage.setItem(key, JSON.stringify(data[key])); }); alert('æ•°æ®å¯¼å…¥æˆåŠŸï¼åº”ç”¨å°†é‡æ–°åŠ è½½ã€‚'); location.reload(); } } catch (error) { alert('å¯¼å…¥å¤±è´¥ï¼è¯·ç¡®ä¿æ–‡ä»¶æ˜¯ç”±æœ¬åº”ç”¨å¯¼å‡ºçš„æ­£ç¡®å¤‡ä»½æ–‡ä»¶ã€‚\né”™è¯¯: ' + error.message); } finally { event.target.value = ''; } }; reader.readAsText(file); }
        const startTimer = () => { clearInterval(state.timerInterval); state.seconds=0; UI.updateStats(); state.timerInterval = setInterval(() => { state.seconds++; UI.updateStats(); }, 1000); };
        const shuffleArray = (a) => { for (let i=a.length-1; i>0; i--) { const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; };
        
        window.addEventListener('load', () => { initDefaultData(); UI.switchScreen('home'); });
        elements.selectHanziBtn.addEventListener('click', () => initializeSubject('hanzi'));
        elements.selectPinyinBtn.addEventListener('click', () => initializeSubject('pinyin'));
        elements.selectEnglishBtn.addEventListener('click', () => initializeSubject('english'));
        elements.bankEditSelect.addEventListener('change', () => UI.populateBankEditor(state.currentSubject, elements.bankEditSelect.value));
        elements.saveBankBtn.addEventListener('click', () => { const name = elements.editBankName.value.trim(); const chars = elements.editBankChars.value.trim().split(/\n+/).filter(Boolean); if (!name || chars.length === 0) { alert('åç§°å’Œå†…å®¹éƒ½ä¸èƒ½ä¸ºç©ºï¼\nè¯·æ³¨æ„ï¼šæ¯ä¸ªè¯æ¡è¯·ç”¨ã€æ¢è¡Œã€‘åˆ†éš”ã€‚'); return; } const banks = DB.getForSubject(state.currentSubject, 'wordBanks', {}); banks[name] = chars; DB.setForSubject(state.currentSubject, 'wordBanks', banks); UI.updateSetupScreen(state.currentSubject); elements.bankEditSelect.value = name; alert(`â€œ${name}â€å·²ä¿å­˜/æ›´æ–°ï¼`); });
        elements.saveWrongCharsBtn.addEventListener('click', () => { const chars = elements.editWrongChars.value.trim().split(/\n+/).filter(Boolean); DB.setForSubject(state.currentSubject, 'wrongChars', [...new Set(chars)]); UI.updateSetupScreen(state.currentSubject); alert('é”™é¢˜æœ¬å·²æ›´æ–°ï¼'); });
        elements.deleteBankBtn.addEventListener('click', () => { const bankName = elements.bankEditSelect.value; if (!bankName) { alert('æ²¡æœ‰é€‰ä¸­çš„å†…å®¹åº“å¯ä»¥åˆ é™¤ï¼'); return; } if (confirm(`ç¡®å®šè¦æ°¸ä¹…åˆ é™¤â€œ${bankName}â€å—ï¼Ÿ`)) { const banks = DB.getForSubject(state.currentSubject, 'wordBanks', {}); delete banks[bankName]; DB.setForSubject(state.currentSubject, 'wordBanks', banks); UI.updateSetupScreen(state.currentSubject); } });
        elements.startBtn.addEventListener('click', () => { const selectedItems = document.querySelectorAll('.bank-item.selected'); if (selectedItems.length === 0) { alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªå†…å®¹åº“ï¼'); return; } const selectedBankNames = [...selectedItems].map(item => item.dataset.bankName); const banks = DB.getForSubject(state.currentSubject, 'wordBanks', {}); const allChars = selectedBankNames.reduce((acc, name) => { if (banks[name] && Array.isArray(banks[name])) { acc.push(...banks[name]); } return acc; }, []); startSession(allChars, `ç»ƒä¹ : ${selectedBankNames.join(', ')}`); });
        elements.practiceWrongBtn.addEventListener('click', () => { const wrongChars = DB.getForSubject(state.currentSubject, 'wrongChars', []); if (wrongChars.length === 0) { alert('é”™é¢˜æœ¬æ˜¯ç©ºçš„ï¼ŒçœŸæ£’ï¼'); return; } startSession(wrongChars, 'é”™é¢˜æœ¬'); });
        elements.correctBtn.addEventListener('click', () => handleAnswer(true));
        elements.incorrectBtn.addEventListener('click', () => handleAnswer(false));
        elements.homeBtn.addEventListener('click', resetAppToHome);
        elements.backToHomeBtn.addEventListener('click', resetAppToHome);
        elements.exportDataBtn.addEventListener('click', exportData);
        elements.importDataBtn.addEventListener('click', () => elements.importFileInput.click());
        elements.importFileInput.addEventListener('change', importData);
    </script>
</body>
</html>